on:
  push:
    branches:
      - main
  workflow_dispatch:

name: Render and Publish

# you need these permissions to publish to GitHub pages
permissions: 
    contents: write
    pages: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # this secret is always available for github actions

    steps:
      - uses: actions/checkout@v4  # Checkout the repo to find files, such as the env
      
      - name: Setup the environment
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment.yaml
          init-shell: bash
          cache-environment: true
          post-cleanup: none

      - name: Build the website
        run: quarto render textbook
        shell: bash -el {0}  # Required to see the mamba init env

      # Push the website to the gh-pages branch 
      - name: Push the PR version of the website to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          keep_files: true
          destination_dir: .
